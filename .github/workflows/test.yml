deploy:
  name: Deploy on Localhost (Windows Runner)
  needs: build-and-push
  runs-on: self-hosted
  env:
    DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
    IMAGE_TAG: latest
  steps:
    - name: Check Docker environment
      shell: cmd
      run: |
        docker --version
        docker compose version

    - name: Docker login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Clone latest code (for compose file)
      shell: cmd
      run: |
        if exist "EProject" rd /s /q "EProject"
        git clone https://github.com/${{ github.repository }}.git EProject
        cd EProject
        git checkout main

    - name: Stop and remove old containers
      shell: cmd
      run: |
        cd EProject
        docker compose down --remove-orphans || exit /b 0

    - name: Pull updated images from Docker Hub
      shell: cmd
      run: |
        docker pull %DOCKERHUB_USERNAME%/api-gateway:%IMAGE_TAG%
        docker pull %DOCKERHUB_USERNAME%/auth:%IMAGE_TAG%
        docker pull %DOCKERHUB_USERNAME%/product:%IMAGE_TAG%
        docker pull %DOCKERHUB_USERNAME%/order:%IMAGE_TAG%

    - name: Create .env for docker-compose
      shell: cmd
      run: |
        cd EProject
        > .env (
          echo DOCKERHUB_USERNAME=%DOCKERHUB_USERNAME%
          echo IMAGE_TAG=%IMAGE_TAG%
        )

    - name: Deploy new containers
      shell: cmd
      run: |
        cd EProject
        docker compose up -d --remove-orphans --force-recreate
        docker ps
